---
title: "GFRN Paper Supplemental Figure 7"
author: "David Jenkins"
date: "Dec 16, 2016"
output:
  html_document:
    toc: true
    toc_float: true
    theme: "united"
---

###Supplemental Figures 7(A)-(D):

```{r,cache=TRUE,echo=FALSE,warning=FALSE}
library(RColorBrewer)
library(ggplot2)
library(gridExtra)
library(reshape2)
#-------------------------------------------------------------------------------
#Input files (Modify These to Your System's Locations):
#-------------------------------------------------------------------------------
input_data_dir <- file.path("/home","david","Dropbox","bild_signatures",
                           "david_results","final_pathway_predictions",
                           "20161214_reanalysis")

icbp_drug_response<-paste(input_data_dir,"ICBP_drugs.txt",sep="/")
drugs<-read.delim(icbp_drug_response, header=1, sep='\t',row.names=1)
rownames(drugs)[38] <- "SUM1315"
rownames(drugs)[45] <- "T47D.Kbluc"
rownames(drugs)[52] <- "MDAMB175"

icbp_predictions_file <- file.path(input_data_dir,
                                   "optimized_single_pathway_icbp_scaled.txt")
single_pathway_best_icbp <-read.table(icbp_predictions_file, stringsAsFactors=FALSE,
                                      header=1, row.names=1,sep='\t')
rownames(single_pathway_best_icbp)[50] <- "T47D.Kbluc"

drugs_all <- drugs[rownames(single_pathway_best_icbp),11:100]

drugs <- drugs[rownames(single_pathway_best_icbp),c("GSK2141795","PF.4691502",
                                                    "Everolimus","Sigma.AKT1.2.inhibitor",
                                                    "GSK1059868","Rapamycin",
                                                    "Temsirolimus","GSK2126458",
                                                    "GSK2119563","GSK1059615",
                                                    "Lapatinib","AG1478",
                                                    "Gefitinib","AZD6244",
                                                    "Erlotinib","GSK1120212",
                                                    "Docetaxel","CGC.11047",
                                                    "Paclitaxel","Cisplatin")]

#-------------------------------------------------------------------------------
#Perform k-means clustering with 4 clusters
#-------------------------------------------------------------------------------
set.seed(123)
kmeans.4 <- kmeans(single_pathway_best_icbp[,c(1,2,3,4)], 4,
                   iter.max=100000, nstart = 100)
kmeans.4.clusters <-data.frame(kmeans.4$cluster)
kmeans.4.clusters[kmeans.4.clusters$kmeans.4.cluster == "3",] <- "Survival/HER2 high"
kmeans.4.clusters[kmeans.4.clusters$kmeans.4.cluster == "1",] <- "Survival/HER2 low"
kmeans.4.clusters[kmeans.4.clusters$kmeans.4.cluster == "4",] <- "Growth/BAD high"
kmeans.4.clusters[kmeans.4.clusters$kmeans.4.cluster == "2",] <- "Growth/BAD low"
colnames(kmeans.4.clusters) <- "KMeans.Clusters"

ttest_boxplots <- function(drugdata, clusters, selected_clustera, selected_clusterb, selected_drug){
  numa <- sum(!is.na(drugdata[rownames(clusters)[clusters == selected_clustera], selected_drug]))
  numb <- sum(!is.na(drugdata[rownames(clusters)[clusters == selected_clusterb], selected_drug]))
  if(numa < 2 | numb < 2){
    return(NA)
  }
  result <- t.test(drugdata[rownames(clusters)[clusters == selected_clustera], selected_drug],
                   drugdata[rownames(clusters)[clusters == selected_clusterb], selected_drug], na.rm=T)
  return(result$p.value)
}

akt.ttest.results <- unlist(lapply(colnames(drugs), function(x) ttest_boxplots(drugs, kmeans.4.clusters, "Survival/HER2 high", "Survival/HER2 low", x)))
akt.ttest.results.fdr <- p.adjust(akt.ttest.results, method="fdr")

egfr.ttest.results <- unlist(lapply(colnames(drugs), function(x) ttest_boxplots(drugs, kmeans.4.clusters, "Growth/BAD high", "Growth/BAD low", x)))
egfr.ttest.results.fdr <- p.adjust(egfr.ttest.results, method="fdr")

ttest_results <- data.frame(akt.ttest.results=akt.ttest.results,
                            akt.ttest.results.fdr=akt.ttest.results.fdr,
                            egfr.ttest.results=egfr.ttest.results,
                            egfr.ttest.results.fdr=egfr.ttest.results.fdr,
                            row.names=colnames(drugs))

kmeans.4.clusters[kmeans.4.clusters$KMeans.Clusters == "Survival/HER2 high",] <- "Survival\nHER2 high"
kmeans.4.clusters[kmeans.4.clusters$KMeans.Clusters == "Survival/HER2 low",] <- "Survival\nHER2 low"
kmeans.4.clusters[kmeans.4.clusters$KMeans.Clusters == "Growth/BAD high",] <- "Growth\nBAD high"
kmeans.4.clusters[kmeans.4.clusters$KMeans.Clusters == "Growth/BAD low",] <- "Growth\nBAD low"
kmeans.4.clusters <- data.frame(kmeans.4.clusters$KMeans.Clusters, row.names = rownames(kmeans.4.clusters) )

pathway_colors <- brewer.pal(5, "Set1")[c(1,2,3,5)]

plot_drug_boxplots_final <- function(drugdata, clusters, selected, fillcolor){
  colnames(clusters) <- "clusters"
  merged <- merge(drugdata, clusters, by=0, all=T)
  merged_melt <- melt(merged, id.vars = c("Row.names", "clusters"))
  merged_melt_s <- merged_melt[merged_melt$variable == selected,]
  theplot <- ggplot(merged_melt_s, aes(factor(clusters, 
                                              levels = c("Survival\nHER2 high",
                                                         "Survival\nHER2 low",
                                                         "Growth\nBAD high",
                                                         "Growth\nBAD low")), value)) +
    geom_boxplot(outlier.shape = NA, fill=fillcolor) + 
    theme_classic() +
    theme(axis.text.x = element_text(angle = 0, hjust = 0.5),
          axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
          axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'),
          plot.title = element_text(hjust = 0.5)) +
    xlab("") +
    ylab("-log(EC50)") +
    ggtitle(selected) +
    geom_point(position=position_jitter(width = 0.1))
  return(theplot)
}

plota <- plot_drug_boxplots_final(drugs, kmeans.4.clusters, "GSK1059615", pathway_colors)
plotb <- plot_drug_boxplots_final(drugs, kmeans.4.clusters, "Lapatinib", pathway_colors)
plotc <- plot_drug_boxplots_final(drugs, kmeans.4.clusters, "AG1478", pathway_colors)
plotd <- plot_drug_boxplots_final(drugs, kmeans.4.clusters, "Gefitinib", pathway_colors)


grid.arrange(plota,plotb,plotc,plotd, nrow=2,ncol=2)

# pdf("SupFig7raw.pdf", width=7, height=6)
# grid.arrange(plota,plotb,plotc,plotd, nrow=2,ncol=2)
# dev.off()

```